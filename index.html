<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Analysis Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        html {
            font-family: 'Inter', sans-serif;
        }

        /* Dark theme base colors (from gpt.html) */
        body {
            --tw-bg-opacity: 1;
            background-color: rgb(15 23 42 / var(--tw-bg-opacity)); /* slate-900 */
            color: #e2e8f0; /* slate-200 */
            min-height: 100vh;
            padding: 2.5rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            line-height: 1.6;
        }

        .card {
            background-color: #1e293b; /* slate-800 */
            color: #e2e8f0; /* slate-200 */
            border-color: #334155; /* slate-700 */
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5), 0 4px 15px -2px rgba(0, 0, 0, 0.3); /* Darker shadows for dark theme */
            border-radius: 1.25rem;
            padding: 3rem;
            max-width: 900px;
            width: 100%;
            text-align: left;
            border: 1px solid;
            position: relative;
            overflow: hidden;
        }

        h1 {
            color: #e2e8f0; /* Light text for headings */
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 2rem;
            text-align: center;
            letter-spacing: -0.02em;
        }
        h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #e2e8f0;
            margin-bottom: 1.5rem;
            text-align: center;
            border-bottom: none;
            padding-bottom: 0;
        }
        h3 {
            font-size: 1.35rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 1rem;
            text-align: left;
            border-bottom: 1px solid #334155; /* Darker border */
            padding-bottom: 0.75rem;
            margin-top: 2rem;
        }
        label {
            color: #e2e8f0;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
            font-size: 0.95rem;
        }
        input[type="text"], input[type="number"] {
            background-color: #334155; /* Darker input background */
            color: #e2e8f0;
            border-color: #475569; /* Darker input border */
            border: 1px solid;
            border-radius: 0.75rem;
            padding: 0.85rem 1.25rem;
            width: 100%;
            font-size: 1.05rem;
            outline: none;
            transition: all 0.25s ease-in-out;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            border-color: #4285F4; /* Google Blue for focus */
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.25);
            background-color: #334155;
        }

        /* Buttons from gpt.html, adapted for dark theme */
        button {
            background-color: #2563eb; /* blue-600 from gpt.html */
            color: #FFFFFF;
            padding: 0.5rem 1rem; /* py-2 px-4 from gpt.html */
            border-radius: 0.375rem; /* rounded-md from gpt.html */
            font-weight: 600; /* font-semibold */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            outline: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3); /* Darker shadow */
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }
        button:hover {
            background-color: #1d4ed8; /* blue-700 from gpt.html */
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            background-color: #2563eb;
        }

        .button-secondary {
            background-color: #334155; /* slate-700 from gpt.html */
            color: #e2e8f0; /* slate-200 */
            border: 1px solid #475569; /* slate-600 equivalent for border */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .button-secondary:hover {
            background-color: #475569; /* slate-600 (darker) for hover */
            color: #e2e8f0;
        }
        .button-secondary:active {
            background-color: #334155;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3); /* Lighter spinner for dark theme */
            border-left-color: #e2e8f0; /* Lighter color for visibility */
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results and Autocomplete styles adjusted for dark theme */
        .results-section {
            background-color: #1e293b;
            border-radius: 1rem;
            padding: 2rem;
            margin-top: 2.5rem;
            border: 1px solid #334155;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px dashed #334155;
            font-size: 1rem;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-item:nth-child(even) {
             background-color: #2d3a4b; /* Slightly different dark for alternating rows */
             padding-left: 0.5rem;
             padding-right: 0.5rem;
             margin-left: -0.5rem;
             margin-right: -0.5rem;
             border-radius: 0.25rem;
        }
        .result-label {
            font-weight: 500;
            color: #94a3b8; /* slate-400 */
            font-size: 0.95rem;
        }
        .result-value {
            font-weight: 700;
            color: #e2e8f0; /* slate-200 */
            font-size: 1rem;
        }
        .upside-positive {
            color: #6ee7b7; /* Green for dark theme */
            font-weight: 800;
            font-size: 1.1rem;
        }
        .upside-negative {
            color: #f87171; /* Red for dark theme */
            font-weight: 800;
            font-size: 1.1rem;
        }
        .error-message {
            color: #fca5a5; /* Light red text for dark theme */
            font-size: 0.95rem;
            margin-top: 1rem;
            font-weight: 600;
            text-align: center;
            background-color: #7f1d1d; /* Dark red background */
            border: 1px solid #ef4444;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
        }
        .disclaimer {
            font-size: 0.75rem;
            color: #94a3b8; /* slate-400 */
            margin-top: 2.5rem;
            text-align: center;
            border-top: 1px solid #334155;
            padding-top: 1.5rem;
            line-height: 1.5;
        }

        .autocomplete-suggestions {
            background-color: #1e293b;
            border-radius: 0.75rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #334155;
        }
        .autocomplete-suggestion-item {
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
            color: #e2e8f0;
            border-bottom: 1px solid #334155;
        }
        .autocomplete-suggestion-item:hover {
            background-color: #2d3a4b;
        }
        .autocomplete-suggestion-item strong {
            color: #4285F4; /* Google Blue */
        }
        .autocomplete-suggestion-item .text-xs {
            color: #94a3b8;
        }

        /* Chart container styling */
        .chart-container {
            background-color: #1e293b;
            border-radius: 1rem;
            border: 1px solid #334155;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
            height: 350px;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .chart-container canvas {
            max-height: 100%;
            max-width: 100%;
        }

        /* Chart.js specific overrides for aesthetics */
        canvas {
            background-color: transparent !important;
        }
        .chartjs-tooltip {
            background: rgba(30, 41, 59, 0.9) !important; /* Darker tooltip background */
            border-radius: 0.5rem !important;
            padding: 0.75rem 1rem !important;
            font-family: 'Inter', sans-serif !important;
            font-size: 0.9rem !important;
            color: #e2e8f0 !important; /* Light text on dark tooltip */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chartjs-tooltip-header {
            padding-bottom: 0.5rem !important;
            margin-bottom: 0.5rem !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            font-weight: 600 !important;
        }
        .chartjs-tooltip-body {
            font-weight: 400 !important;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            .card {
                padding: 1.5rem;
                border-radius: 1rem;
            }
            h1 {
                font-size: 2rem;
                margin-bottom: 1.5rem;
            }
            h2 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
            h3 {
                font-size: 1.2rem;
                margin-top: 1.5rem;
                padding-bottom: 0.5rem;
            }
            input[type="text"], input[type="number"], button {
                padding: 0.75rem 1rem;
                font-size: 0.95rem;
                border-radius: 0.6rem;
            }
            .result-item, .autocomplete-suggestion-item {
                font-size: 0.9rem;
            }
            .upside-positive, .upside-negative {
                font-size: 1rem;
            }
            .chart-container {
                height: 280px;
                padding: 1rem;
                margin-top: 1.5rem;
                margin-bottom: 1.5rem;
            }
            .flex-col.sm\:flex-row {
                flex-direction: column;
            }
            .grid.grid-cols-1.sm\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen p-4">

    <div class="max-w-4xl mx-auto card bg-slate-800 shadow-xl p-8 rounded-2xl border border-slate-700">
        <h1 class="text-3xl font-bold text-white mb-6">Company Analysis Dashboard 📈</h1>

        <div class="mb-5 autocomplete-container">
            <label for="stockSymbol" class="block font-medium mb-1">Stock Symbol (e.g., AAPL)</label>
            <input id="stockSymbol" type="text" autocomplete="off" class="w-full px-4 py-2 border rounded-md" placeholder="Enter symbol or company name">
            <ul id="autocompleteSuggestions" class="autocomplete-suggestions hidden">
                <!-- Suggestions will be populated here -->
            </ul>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <div>
                <label for="earningsGrowthInput" class="block font-medium mb-1">Earnings Growth (G, %):</label>
                <input id="earningsGrowthInput" type="number" value="8" min="0" step="0.1" class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
                <label for="marginOfSafetyInput" class="block font-medium mb-1">Desired Margin of Safety (%, e.g., 25 for 25%):</label>
                <input id="marginOfSafetyInput" type="number" value="25" min="0" step="1" class="w-full px-4 py-2 border rounded-md">
            </div>
        </div>

        <div class="border-t border-slate-600 mt-6 pt-6">
            <h3 class="text-xl font-semibold mb-4">Valuation Model Inputs</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="grahamBondYield" class="block font-medium mb-1">Graham Bond Yield (%):</label>
                    <input id="grahamBondYield" type="number" value="4.4" min="0" step="0.1" class="w-full px-4 py-2 border rounded-md">
                </div>
                <div>
                    <label for="grahamGrowthlessPE" class="block font-medium mb-1">Graham Growthless P/E:</label>
                    <input id="grahamGrowthlessPE" type="number" value="8.5" min="0" step="0.1" class="w-full px-4 py-2 border rounded-md">
                </div>
                <div>
                    <label for="dcfDiscountRate" class="block font-medium mb-1">DCF Discount Rate (%):</label>
                    <input id="dcfDiscountRate" type="number" value="10" min="0" step="0.1" class="w-full px-4 py-2 border rounded-md">
                </div>
                <div>
                    <label for="dcfTerminalPE" class="block font-medium mb-1">DCF Terminal P/E:</label>
                    <input id="dcfTerminalPE" type="number" value="20" min="0" step="1" class="w-full px-4 py-2 border rounded-md">
                </div>
                <div class="sm:col-span-2">
                    <label for="targetPB" class="block font-medium mb-1">Target P/B Ratio:</label>
                    <input id="targetPB" type="number" value="2.5" min="0" class="w-full px-4 py-2 border rounded-md" />
                </div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mt-6">
            <button id="calculateBtn">Calculate Fair Value</button>
            <button id="resetBtn" class="button-secondary">Reset</button>
        </div>

        <div id="loadingIndicator" class="hidden mt-4 flex items-center gap-2 text-blue-600">
            <span class="loading-spinner border-4 border-t-blue-600 w-5 h-5 rounded-full animate-spin"></span>
            <span>Fetching data...</span>
        </div>

        <div id="errorMessage" class="hidden text-red-500 font-semibold mt-4"></div>

        <div id="results" class="results-section hidden">
            <h2 class="text-2xl font-bold mb-4">Company Overview & Valuation</h2>
            
            <h3 class="text-xl font-semibold mb-3">Key Financial Metrics</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                <div class="result-item">
                    <span class="result-label">Company Name:</span>
                    <span id="companyNameDisplay" class="result-value"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">Exchange:</span>
                    <span id="exchangeDisplay" class="result-value"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">Market Cap:</span>
                    <span id="marketCapDisplay" class="result-value"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">Enterprise Value:</span>
                    <span id="enterpriseValueDisplay" class="result-value"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">Current Price:</span>
                    <span id="currentPriceDisplay" class="result-value"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">EPS (TTM):</span>
                    <span id="epsDisplay" class="result-value"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">P/E Ratio:</span>
                    <span id="peRatioDisplay" class="result-value"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">Forward P/E:</span>
                    <span id="forwardPeDisplay" class="result-value"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">Dividend Yield:</span>
                    <span id="dividendYieldDisplay" class="result-value"></span>
                </div>
                 <div class="result-item">
                    <span class="result-label">Book Value Per Share:</span>
                    <span id="bookValuePerShareDisplay" class="result-value"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">52 Week High:</span>
                    <span id="weekHighDisplay" class="result-value"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">52 Week Low:</span>
                    <span id="weekLowDisplay" class="result-value"></span>
                </div>
                <div class="result-item sm:col-span-2">
                    <span class="result-label">Earnings Growth (User/Analyst):</span>
                    <span id="growthDisplay" class="result-value"></span>
                </div>
            </div>

            <h3 class="text-xl font-semibold mt-6 mb-3">Valuation Model Outputs</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                <div class="result-item">
                    <span class="result-label">Intrinsic Value (Graham):</span>
                    <span id="intrinsicValueDisplay" class="result-value"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">DCF Value (Simplified):</span>
                    <span id="dcfValueDisplay" class="result-value"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">P/B Value (Target P/B 2.5):</span>
                    <span id="pbValueDisplay" class="result-value"></span>
                </div>
            </div>

            <div class="result-item font-bold text-lg mt-4">
                <span class="result-label">Average Fair Value:</span>
                <span id="averageFairValueDisplay" class="result-value text-blue-600"></span>
            </div>
            <div class="result-item font-bold text-lg">
                <span class="result-label">Fair Value (with MOS):</span>
                <span id="mosFairValueDisplay" class="result-value text-blue-600"></span>
            </div>
            <div class="result-item font-bold text-lg">
                <span class="result-label">Upside Potential (from Avg FV):</span>
                <span id="upsideDisplay" class="result-value"></span>
            </div>
            <div class="result-item font-bold text-lg">
                <span class="result-label">Upside Potential (from MOS FV):</span>
                <span id="upsideMosDisplay" class="result-value"></span>
            </div>

            <!-- Charts Section -->
            <div class="mt-8 pt-6 border-t border-slate-600">
                <h3 class="text-xl font-semibold mb-4 text-center">Visualizations</h3>
                <div class="chart-container">
                    <canvas id="historicalPriceChart"></canvas>
                    <div id="historicalPriceNoData" class="text-center text-slate-400 mt-4 hidden">No historical price data available.</div>
                </div>
                <div class="chart-container">
                    <canvas id="valuationComparisonChart"></canvas>
                    <div id="valuationComparisonNoData" class="text-center text-slate-400 mt-4 hidden">No valuation comparison data available.</div>
                </div>
            </div>
        </div>
        <div class="disclaimer text-xs text-slate-500 mt-10 border-t pt-4 border-slate-600">
            <strong>Disclaimer:</strong> Data is from Alpha Vantage (subject to API limits). Valuation models are simplified and for educational use only.
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const stockSymbolInput = document.getElementById('stockSymbol');
            const earningsGrowthInput = document.getElementById('earningsGrowthInput');
            const marginOfSafetyInput = document.getElementById('marginOfSafetyInput');
            
            // User-editable valuation constants
            const grahamBondYieldInput = document.getElementById('grahamBondYield');
            const grahamGrowthlessPEInput = document.getElementById('grahamGrowthlessPE');
            const dcfDiscountRateInput = document.getElementById('dcfDiscountRate');
            const dcfTerminalPEInput = document.getElementById('dcfTerminalPE');
            const targetPBInput = document.getElementById('targetPB');

            const calculateBtn = document.getElementById('calculateBtn');
            const resetBtn = document.getElementById('resetBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const resultsDiv = document.getElementById('results');
            const autocompleteSuggestions = document.getElementById('autocompleteSuggestions');

            // Display elements for results
            const companyNameDisplay = document.getElementById('companyNameDisplay');
            const exchangeDisplay = document.getElementById('exchangeDisplay');
            const marketCapDisplay = document.getElementById('marketCapDisplay');
            const enterpriseValueDisplay = document.getElementById('enterpriseValueDisplay');
            const currentPriceDisplay = document.getElementById('currentPriceDisplay');
            const epsDisplay = document.getElementById('epsDisplay');
            const peRatioDisplay = document.getElementById('peRatioDisplay');
            const forwardPeDisplay = document.getElementById('forwardPeDisplay');
            const dividendYieldDisplay = document.getElementById('dividendYieldDisplay');
            const bookValuePerShareDisplay = document.getElementById('bookValuePerShareDisplay');
            const weekHighDisplay = document.getElementById('weekHighDisplay');
            const weekLowDisplay = document.getElementById('weekLowDisplay');
            const growthDisplay = document.getElementById('growthDisplay');
            const intrinsicValueDisplay = document.getElementById('intrinsicValueDisplay');
            const dcfValueDisplay = document.getElementById('dcfValueDisplay');
            const pbValueDisplay = document.getElementById('pbValueDisplay');
            const averageFairValueDisplay = document.getElementById('averageFairValueDisplay');
            const mosFairValueDisplay = document.getElementById('mosFairValueDisplay');
            const upsideDisplay = document.getElementById('upsideDisplay');
            const upsideMosDisplay = document.getElementById('upsideMosDisplay');

            // Chart instances
            let historicalPriceChartInstance = null;
            let valuationComparisonChartInstance = null;

            // New DOM elements for no data messages
            const historicalPriceNoData = document.getElementById('historicalPriceNoData');
            const valuationComparisonNoData = document.getElementById('valuationComparisonNoData');

            // --- Constants ---
            const DCF_PROJECTION_YEARS = 5;
            const DEBOUNCE_DELAY = 300; // milliseconds for autocomplete

            // Caching configuration
            const STOCK_DATA_CACHE_DURATION_MS = 5 * 60 * 1000; // 5 minutes for main stock data
            const SUGGESTION_CACHE_DURATION_MS = 1 * 60 * 1000; // 1 minute for suggestions

            const stockDataCache = {};
            const suggestionCache = {};

            // --- Helper Functions ---

            /**
             * Displays an error message and updates UI state.
             * @param {string} message The error message to display.
             */
            function displayError(message) {
                console.error("Displaying error:", message); // Log the error being displayed
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
                loadingIndicator.classList.add('hidden'); // Hide general loader
                calculateBtn.disabled = false;
                calculateBtn.innerHTML = 'Calculate Fair Value'; // Reset button text
                resetBtn.disabled = false;
            }

            /**
             * Formats a large number into a human-readable string (e.g., 1.23T, 45.6B, 789M).
             * @param {number} num The number to format.
             * @returns {string} The formatted string.
             */
            function formatLargeNumber(num) {
                if (isNaN(num) || num === 0) return 'N/A';
                const absNum = Math.abs(num);
                if (absNum >= 1.0e12) return (num / 1.0e12).toFixed(2) + "T";
                if (absNum >= 1.0e9) return (num / 1.0e9).toFixed(2) + "B";
                if (absNum >= 1.0e6) return (num / 1.0e6).toFixed(2) + "M";
                return num.toFixed(2);
            }

            /**
             * Resets the form and clears all results and charts.
             */
            const resetForm = () => {
                stockSymbolInput.value = '';
                earningsGrowthInput.value = '8'; // Reset to default
                marginOfSafetyInput.value = '25'; // Reset to default
                grahamBondYieldInput.value = '4.4'; // Reset to default
                grahamGrowthlessPEInput.value = '8.5'; // Reset to default
                dcfDiscountRateInput.value = '10'; // Reset to default
                dcfTerminalPEInput.value = '20'; // Reset to default
                targetPBInput.value = '2.5'; // Reset to default

                resultsDiv.classList.add('hidden');
                errorMessage.classList.add('hidden');
                errorMessage.textContent = '';
                loadingIndicator.classList.add('hidden');
                calculateBtn.disabled = false;
                calculateBtn.innerHTML = 'Calculate Fair Value'; // Reset button text
                resetBtn.disabled = false;
                autocompleteSuggestions.classList.add('hidden');

                // Destroy existing chart instances
                if (historicalPriceChartInstance) {
                    historicalPriceChartInstance.destroy();
                    historicalPriceChartInstance = null;
                }
                if (valuationComparisonChartInstance) {
                    valuationComparisonChartInstance.destroy();
                    valuationComparisonChartInstance = null;
                }
                historicalPriceNoData.classList.add('hidden');
                valuationComparisonNoData.classList.add('hidden');
            };

            /**
             * Debounces a function call.
             * @param {Function} func The function to debounce.
             * @param {number} delay The debounce delay in milliseconds.
             * @returns {Function} The debounced function.
             */
            const debounce = (func, delay) => {
                let timeoutId;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(context, args), delay);
                };
            };

            /**
             * Creates an Alpha Vantage API configuration object for RapidAPI.
             * @param {string} name The name for this API key config.
             * @param {string} apiKey The RapidAPI key.
             * @returns {object} An API configuration object.
             */
            const createRapidApiAlphaVantageConfig = (name, apiKey) => ({
                name: name,
                apiKey: apiKey,
                baseUrl: 'https://alpha-vantage.p.rapidapi.com/query', // RapidAPI endpoint
                headers: {
                    'x-rapidapi-key': apiKey,
                    'x-rapidapi-host': 'alpha-vantage.p.rapidapi.com'
                },
                fetchData: async (symbol, currentApiKey, headers) => {
                    const cacheKey = `stock_data_${symbol}`;
                    const cachedData = stockDataCache[cacheKey];

                    if (cachedData && (Date.now() - cachedData.timestamp < STOCK_DATA_CACHE_DURATION_MS)) {
                        console.log(`[${name}] Serving stock data for ${symbol} from cache.`);
                        return cachedData.data;
                    }

                    console.log(`[${name}] Attempting to fetch data for symbol: ${symbol}`);
                    const quoteUrl = `https://alpha-vantage.p.rapidapi.com/query?function=GLOBAL_QUOTE&symbol=${symbol}`;
                    const overviewUrl = `https://alpha-vantage.p.rapidapi.com/query?function=OVERVIEW&symbol=${symbol}`;
                    const historicalUrl = `https://alpha-vantage.p.rapidapi.com/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=${symbol}`; // Removed outputsize=compact

                    const [quoteResponse, overviewResponse, historicalResponse] = await Promise.all([
                        fetch(quoteUrl, { headers: headers }),
                        fetch(overviewUrl, { headers: headers }),
                        fetch(historicalUrl, { headers: headers })
                    ]);

                    console.log(`[${name}] Quote Response Status: ${quoteResponse.status}`);
                    console.log(`[${name}] Overview Response Status: ${overviewResponse.status}`);
                    console.log(`[${name}] Historical Response Status: ${historicalResponse.status}`);

                    // More detailed error logging for API failures
                    if (!quoteResponse.ok) {
                        const errorText = await quoteResponse.text();
                        console.error(`[${name}] Quote API failed with status ${quoteResponse.status}:`, errorText);
                        throw new Error(`RapidAPI Alpha Vantage Quote failed: ${quoteResponse.statusText}. Details: ${errorText}`);
                    }
                    if (!overviewResponse.ok) {
                        const errorText = await overviewResponse.text();
                        console.error(`[${name}] Overview API failed with status ${overviewResponse.status}:`, errorText);
                        throw new Error(`RapidAPI Alpha Vantage Overview failed: ${overviewResponse.statusText}. Details: ${errorText}`);
                    }
                    if (!historicalResponse.ok) {
                        const errorText = await historicalResponse.text();
                        console.error(`[${name}] Historical API failed with status ${historicalResponse.status}:`, errorText);
                        throw new Error(`RapidAPI Alpha Vantage Historical failed: ${historicalResponse.statusText}. Details: ${errorText}`);
                    }

                    const quoteData = await quoteResponse.json();
                    const overviewData = await overviewResponse.json();
                    const historicalData = await historicalResponse.json();

                    console.log(`[${name}] Raw Quote Data:`, quoteData);
                    console.log(`[${name}] Raw Overview Data:`, overviewData);
                    console.log(`[${name}] Raw Historical Data:`, historicalData);

                    // Check for API-specific error messages (Alpha Vantage often returns 'Error Message' or 'Note' for limits)
                    if (quoteData['Error Message'] || overviewData['Error Message'] || historicalData['Error Message'] ||
                        quoteData['Note'] || overviewData['Note'] || historicalData['Note']) {
                        const errorMessage = quoteData['Error Message'] || overviewData['Error Message'] || historicalData['Error Message'] ||
                                              quoteData['Note'] || overviewData['Note'] || historicalData['Note'] ||
                                              `${name} API error or rate limit reached.`;
                        console.error(`[${name}] API returned an error message:`, errorMessage);
                        throw new Error(errorMessage);
                    }
                    // Check if expected data exists
                    if (!quoteData['Global Quote'] || !overviewData['Symbol']) {
                         const missingDataError = `${name} did not return expected data for the symbol.`;
                         console.error(`[${name}] Missing expected data:`, quoteData['Global Quote'], overviewData['Symbol']);
                         throw new Error(missingDataError);
                    }

                    // Parse data
                    const currentPrice = parseFloat(quoteData['Global Quote']['05. price']);
                    const eps = parseFloat(overviewData['EPS']);
                    const peRatio = parseFloat(overviewData['PERatio']);
                    const forwardPe = parseFloat(overviewData['ForwardPE']);
                    const dividendYield = parseFloat(overviewData['DividendYield']) * 100; // Convert to percentage
                    const bookValue = parseFloat(overviewData['BookValue']);
                    const sharesOutstanding = parseFloat(overviewData['SharesOutstanding']);
                    const marketCap = parseFloat(overviewData['MarketCapitalization']);
                    const enterpriseValue = parseFloat(overviewData['EV']);
                    const fiftyTwoWeekHigh = parseFloat(overviewData['52WeekHigh']);
                    const fiftyTwoWeekLow = parseFloat(overviewData['52WeekLow']);
                    const companyName = overviewData['Name'];
                    const exchange = overviewData['Exchange'];
                    
                    let earningsGrowthFromAPI = null;
                    if (overviewData['QuarterlyEarningsGrowthYOY']) {
                        const qtrGrowth = parseFloat(overviewData['QuarterlyEarningsGrowthYOY']);
                        if (!isNaN(qtrGrowth)) {
                            earningsGrowthFromAPI = qtrGrowth * 100; // Convert to percentage for display
                        }
                    }

                    const historicalPrices = [];
                    const historicalDates = [];
                    if (historicalData['Time Series (Daily)']) {
                        const timeSeries = historicalData['Time Series (Daily)'];
                        const dates = Object.keys(timeSeries).slice(0, 90).reverse(); // Get last 90 days, reverse for chronological
                        dates.forEach(date => {
                            historicalDates.push(date);
                            historicalPrices.push(parseFloat(timeSeries[date]['5. adjusted close']));
                        });
                    }
                    const resultData = { currentPrice, eps, peRatio, forwardPe, dividendYield, bookValue, sharesOutstanding, marketCap, enterpriseValue, fiftyTwoWeekHigh, fiftyTwoWeekLow, companyName, exchange, historicalPrices, historicalDates, earningsGrowthFromAPI };
                    console.log(`[${name}] Parsed Data:`, resultData);
                    
                    // Log raw MarketCapitalization and EV for debugging
                    console.log(`[${name}] Raw MarketCapitalization from API:`, overviewData['MarketCapitalization']);
                    console.log(`[${name}] Raw EV from API:`, overviewData['EV']);

                    // Store in cache
                    stockDataCache[cacheKey] = { data: resultData, timestamp: Date.now() };
                    console.log(`[${name}] Stock data for ${symbol} cached.`);

                    return resultData;
                },
                fetchSuggestions: async (keywords, currentApiKey, headers) => {
                    const cacheKey = `suggestions_${keywords}`;
                    const cachedSuggestions = suggestionCache[cacheKey];

                    if (cachedSuggestions && (Date.now() - cachedSuggestions.timestamp < SUGGESTION_CACHE_DURATION_MS)) {
                        console.log(`[${name}] Serving suggestions for "${keywords}" from cache.`);
                        return cachedSuggestions.data;
                    }

                    console.log(`[${name}] Attempting to fetch suggestions for keywords: ${keywords}`);
                    const searchUrl = `https://alpha-vantage.p.rapidapi.com/query?function=SYMBOL_SEARCH&keywords=${keywords}`;
                    const response = await fetch(searchUrl, { headers: headers });
                    console.log(`[${name}] Suggestion Response Status: ${response.status}`);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`[${name}] Suggestion API failed with status ${response.status}:`, errorText);
                        throw new Error(`RapidAPI Alpha Vantage search failed: ${response.statusText}. Details: ${errorText}`);
                    }
                    const data = await response.json();
                    console.log(`[${name}] Raw Suggestion Data:`, data);
                    if (data['Error Message'] || data['Note']) throw new Error(`RapidAPI Alpha Vantage search error: ${data['Error Message'] || data['Note']}`);
                    
                    const resultSuggestions = data.bestMatches || [];
                    
                    // Store in cache
                    suggestionCache[cacheKey] = { data: resultSuggestions, timestamp: Date.now() };
                    console.log(`[${name}] Suggestions for "${keywords}" cached.`);
                    
                    return resultSuggestions;
                }
            });

            // --- API Configurations (Now using RapidAPI Alpha Vantage) ---
            const API_CONFIGS = [
                // IMPORTANT: Replace 'YOUR_RAPIDAPI_ALPHA_VANTAGE_API_KEY' with your actual RapidAPI Alpha Vantage API Key
                createRapidApiAlphaVantageConfig('RapidAPI Alpha Vantage', '7b1376c647msh2d95bf797c17c41p11c0c6jsn6be501ad4e40')
            ];

            /**
             * Fetches and displays autocomplete suggestions from available APIs.
             * @param {string} query The search keywords.
             */
            const fetchAndDisplaySuggestions = async (query) => {
                // Always hide suggestions at the start of a new query
                autocompleteSuggestions.classList.add('hidden');
                autocompleteSuggestions.innerHTML = ''; // Clear previous suggestions

                if (query.length < 2) {
                    return;
                }

                console.log(`[Autocomplete] Fetching suggestions for query: "${query}"`);
                
                for (const api of API_CONFIGS) {
                    try {
                        const matches = await api.fetchSuggestions(query, api.apiKey, api.headers); // Pass headers
                        console.log(`[Autocomplete] Received ${matches.length} matches from ${api.name}.`);
                        if (matches && matches.length > 0) {
                            matches.forEach(match => {
                                const symbol = match['1. symbol'];
                                const name = match['2. name'];
                                const region = match['4. region'];
                                const type = match['3. type'];

                                const listItem = document.createElement('li');
                                listItem.classList.add('autocomplete-suggestion-item');
                                listItem.innerHTML = `<strong>${symbol}</strong> - ${name} (${type}, ${region}) <span class="text-xs text-slate-400">(${api.name})</span>`;
                                listItem.dataset.symbol = symbol;

                                listItem.addEventListener('click', () => {
                                    stockSymbolInput.value = symbol;
                                    autocompleteSuggestions.classList.add('hidden');
                                });
                                autocompleteSuggestions.appendChild(listItem);
                            });
                            autocompleteSuggestions.classList.remove('hidden');
                            console.log("[Autocomplete] Suggestions displayed.");
                            return; // Stop after first successful API provides suggestions
                        }
                    } catch (error) {
                        console.warn(`[Autocomplete] From ${api.name} failed:`, error.message);
                        // Continue to next API
                    }
                }
                console.log("[Autocomplete] No suggestions found or all APIs failed.");
                autocompleteSuggestions.classList.add('hidden'); // Ensure hidden if no API provides suggestions
            };

            const debouncedFetchAndDisplaySuggestions = debounce(fetchAndDisplaySuggestions, DEBOUNCE_DELAY);

            /**
             * Renders the historical price chart.
             * @param {Array<string>} labels Dates for the X-axis.
             * @param {Array<number>} data Prices for the Y-axis.
             */
            const renderHistoricalPriceChart = (labels, data) => {
                const ctx = document.getElementById('historicalPriceChart').getContext('2d');
                if (historicalPriceChartInstance) {
                    historicalPriceChartInstance.destroy();
                }
                
                if (data.length === 0) {
                    historicalPriceNoData.classList.remove('hidden');
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas if no data
                    return; // Don't render chart if no data
                } else {
                    historicalPriceNoData.classList.add('hidden');
                }

                historicalPriceChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Adjusted Close Price',
                            data: data,
                            borderColor: '#4285F4', /* Google Blue for dark theme */
                            backgroundColor: 'rgba(66, 133, 244, 0.15)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#e2e8f0' /* Light text for legend */
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#e2e8f0', /* Light text for x-axis ticks */
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#e2e8f0', /* Light text for y-axis ticks */
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)' /* Subtle light grey grid lines */
                                }
                            }
                        }
                    }
                });
            };

            /**
             * Renders the valuation comparison bar chart.
             * @param {number} currentPrice The current stock price.
             * @param {number} grahamValue Intrinsic value from Graham formula.
             * @param {number} dcfValue Discounted Cash Flow value.
             * @param {number} pbValue Price-to-Book value.
             * @param {number} averageFairValue Average of calculated fair values.
             * @param {number} mosFairValue Fair value adjusted for Margin of Safety.
             */
            const renderValuationComparisonChart = (currentPrice, grahamValue, dcfValue, pbValue, averageFairValue, mosFairValue) => {
                const ctx = document.getElementById('valuationComparisonChart').getContext('2d');
                if (valuationComparisonChartInstance) {
                    valuationComparisonChartInstance.destroy();
                }

                // Check if there's meaningful data to display for the comparison chart
                if (averageFairValue === 0 || isNaN(averageFairValue) || currentPrice === 0 || isNaN(currentPrice)) {
                    valuationComparisonNoData.classList.remove('hidden');
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas if no data
                    return; // Don't render chart if no meaningful data
                } else {
                    valuationComparisonNoData.classList.add('hidden');
                }

                valuationComparisonChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Current Price', 'Graham Value', 'DCF Value', 'P/B Value', 'Average Fair Value', 'MOS Fair Value'],
                        datasets: [{
                            label: 'Value ($)',
                            data: [currentPrice, grahamValue, dcfValue, pbValue, averageFairValue, mosFairValue],
                            backgroundColor: [
                                '#94a3b8', /* slate-400 */
                                '#4285F4', /* Google Blue */
                                '#34A853', /* Success Green */
                                '#FBBC04', /* Google Yellow */
                                '#1A73E8', /* Primary Blue */
                                '#174EA6'  /* Darker Primary Blue */
                            ],
                            borderColor: [
                                '#64748b',
                                '#1A73E8',
                                '#1E8E3E',
                                '#F9AB00',
                                '#0D47A1',
                                '#0B3A82'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: $${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#e2e8f0' /* Light text for x-axis ticks */
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#e2e8f0', /* Light text for y-axis ticks */
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)' /* Subtle light grey grid lines */
                                }
                            }
                        }
                    }
                });
            };


            // --- Event Listeners ---

            stockSymbolInput.addEventListener('input', (event) => {
                const query = event.target.value.trim();
                if (query) {
                    debouncedFetchAndDisplaySuggestions(query);
                } else {
                    autocompleteSuggestions.classList.add('hidden');
                }
            });

            document.addEventListener('click', (event) => {
                if (!event.target.closest('.autocomplete-container')) {
                    autocompleteSuggestions.classList.add('hidden');
                }
            });

            resetBtn.addEventListener('click', resetForm);

            calculateBtn.addEventListener('click', async () => {
                console.log("Calculate button clicked.");
                const symbol = stockSymbolInput.value.trim().toUpperCase();
                let userEarningsGrowth = parseFloat(earningsGrowthInput.value) / 100; // Convert to decimal
                const userMarginOfSafety = parseFloat(marginOfSafetyInput.value) / 100; // Convert to decimal

                // Get user-defined valuation constants
                const grahamBondYield = parseFloat(grahamBondYieldInput.value);
                const grahamGrowthlessPE = parseFloat(grahamGrowthlessPEInput.value);
                const dcfDiscountRate = parseFloat(dcfDiscountRateInput.value) / 100; // Convert to decimal
                const dcfTerminalPE = parseFloat(dcfTerminalPEInput.value);
                const targetPB = parseFloat(targetPBInput.value); // Correctly parse the value from the input


                // --- UI State Management ---
                resultsDiv.classList.add('hidden');
                errorMessage.classList.add('hidden');
                errorMessage.textContent = '';
                calculateBtn.disabled = true;
                resetBtn.disabled = true;
                autocompleteSuggestions.classList.add('hidden');
                historicalPriceNoData.classList.add('hidden'); // Hide on new calculation
                valuationComparisonNoData.classList.add('hidden'); // Hide on new calculation


                // Show loader animation inside the button
                calculateBtn.innerHTML = '<span class="loading-spinner"></span> Calculating...';

                // Destroy existing charts
                if (historicalPriceChartInstance) historicalPriceChartInstance.destroy();
                if (valuationComparisonChartInstance) valuationComparisonChartInstance.destroy();

                // --- Input Validation ---
                if (!symbol) {
                    displayError('Please enter a stock symbol.');
                    console.log("Validation Error: No stock symbol entered.");
                    return;
                }
                if (isNaN(userEarningsGrowth) || userEarningsGrowth < 0) {
                    displayError('Please enter a valid non-negative earnings growth percentage.');
                    console.log("Validation Error: Invalid earnings growth.");
                    return;
                }
                if (isNaN(userMarginOfSafety) || userMarginOfSafety < 0) {
                    displayError('Please enter a valid non-negative Margin of Safety percentage.');
                    console.log("Validation Error: Invalid margin of safety.");
                    return;
                }
                if (isNaN(grahamBondYield) || grahamBondYield <= 0 || isNaN(grahamGrowthlessPE) || grahamGrowthlessPE <= 0 ||
                    isNaN(dcfDiscountRate) || dcfDiscountRate <= 0 || isNaN(dcfTerminalPE) || dcfTerminalPE <= 0 ||
                    isNaN(targetPB) || targetPB <= 0) { // Use the parsed targetPB here
                    displayError('Please ensure all valuation model inputs are valid positive numbers.');
                    console.log("Validation Error: Invalid valuation model inputs.");
                    return;
                }
                console.log("Input validation passed.");


                let fetchedData = null;
                let lastError = '';

                // --- Data Fetching Logic (Fallback) ---
                for (const api of API_CONFIGS) {
                    try {
                        console.log(`Attempting to fetch data from ${api.name}...`);
                        // Pass API key and headers to fetchData
                        fetchedData = await api.fetchData(symbol, api.apiKey, api.headers); 
                        console.log(`Successfully fetched data from ${api.name}.`);
                        break; // Exit loop if data is successfully fetched
                    } catch (error) {
                        console.error(`Error fetching from ${api.name}:`, error.message);
                        lastError = `Failed to fetch from ${api.name}. Reason: ${error.message}.`;
                        // Continue to the next API
                    }
                }

                if (!fetchedData) {
                    displayError(`All API attempts failed. ${lastError} Please try again later or check the stock symbol.`);
                    console.error("Data fetching failed for all APIs.");
                    return;
                }

                try {
                    console.log("Starting valuation calculations with fetched data.");
                    // Destructure fetched data and ensure numbers
                    let { currentPrice, eps, peRatio, forwardPe, dividendYield, bookValue, sharesOutstanding, marketCap, enterpriseValue, fiftyTwoWeekHigh, fiftyTwoWeekLow, companyName, exchange, historicalPrices, historicalDates, earningsGrowthFromAPI } = fetchedData;
                    
                    currentPrice = parseFloat(currentPrice) || 0;
                    eps = parseFloat(eps) || 0;
                    peRatio = parseFloat(peRatio) || 0;
                    forwardPe = parseFloat(forwardPe) || 0;
                    dividendYield = parseFloat(dividendYield) || 0;
                    bookValue = parseFloat(bookValue) || 0;
                    sharesOutstanding = parseFloat(sharesOutstanding) || 1;
                    marketCap = parseFloat(marketCap) || 0;
                    enterpriseValue = parseFloat(enterpriseValue) || 0;
                    fiftyTwoWeekHigh = parseFloat(fiftyTwoWeekHigh) || 0;
                    fiftyTwoWeekLow = parseFloat(fiftyTwoWeekLow) || 0;

                    // Update earnings growth input with API data if user hasn't modified it from default
                    if (earningsGrowthInput.value === '8' && earningsGrowthFromAPI !== null && !isNaN(earningsGrowthFromAPI)) {
                        earningsGrowthInput.value = earningsGrowthFromAPI.toFixed(1); // Set suggested value in input
                        userEarningsGrowth = earningsGrowthFromAPI / 100; // Use this for calculation
                        console.log(`Updated earnings growth to API suggested: ${earningsGrowthFromAPI.toFixed(1)}%`);
                    } else {
                        // Otherwise, use the user's current input value for calculation
                        userEarningsGrowth = parseFloat(earningsGrowthInput.value) / 100;
                        console.log(`Using user-defined earnings growth: ${(userEarningsGrowth * 100).toFixed(1)}%`);
                    }

                    const growthRateDecimal = userEarningsGrowth;

                    // --- Valuation Calculations ---
                    // 1. Graham Intrinsic Value: V = EPS * (8.5 + 2G) * 4.4 / Y
                    // Where 8.5 is the P/E ratio of a company with no growth, G is the earnings growth rate,
                    // 4.4 is the average yield of high-grade corporate bonds, and Y is the current yield of AAA corporate bonds.
                    // Using user-defined bond yield for Y, but simplified to 4.4/user_bond_yield
                    const grahamIntrinsicValue = eps * (grahamGrowthlessPE + (2 * (growthRateDecimal * 100))) * (grahamBondYield / 4.4);
                    console.log("Graham Intrinsic Value:", grahamIntrinsicValue.toFixed(2));


                    // 2. Simplified DCF Value
                    let projectedEPS = eps;
                    for (let i = 0; i < DCF_PROJECTION_YEARS; i++) {
                        projectedEPS *= (1 + growthRateDecimal);
                    }
                    const terminalValue = projectedEPS * dcfTerminalPE;
                    const dcfValue = terminalValue / Math.pow((1 + dcfDiscountRate), DCF_PROJECTION_YEARS);
                    console.log("DCF Value:", dcfValue.toFixed(2));

                    // 3. P/B Value
                    const bookValuePerShare = bookValue; // Assuming 'bookValue' from APIs is already per share
                    const pbValue = bookValuePerShare * targetPB; // Use the parsed targetPB here
                    console.log("P/B Value:", pbValue.toFixed(2));

                    // Average Fair Value (only consider valid, positive valuations)
                    const validValuations = [grahamIntrinsicValue, dcfValue, pbValue].filter(val => !isNaN(val) && val > 0);
                    const averageFairValue = validValuations.length > 0 ? validValuations.reduce((sum, val) => sum + val, 0) / validValuations.length : 0;
                    console.log("Average Fair Value:", averageFairValue.toFixed(2));

                    // Margin of Safety Adjusted Fair Value
                    const mosFairValue = averageFairValue / (1 + userMarginOfSafety);
                    console.log("MOS Fair Value:", mosFairValue.toFixed(2));

                    // Upside Potential
                    const upsidePercentage = ((averageFairValue - currentPrice) / currentPrice) * 100;
                    const upsideMosPercentage = ((mosFairValue - currentPrice) / currentPrice) * 100;
                    console.log("Upside Potential (Avg FV):", upsidePercentage.toFixed(2) + "%");
                    console.log("Upside Potential (MOS FV):", upsideMosPercentage.toFixed(2) + "%");

                    // --- Display Results ---
                    companyNameDisplay.textContent = companyName || 'N/A';
                    exchangeDisplay.textContent = exchange || 'N/A';
                    marketCapDisplay.textContent = formatLargeNumber(marketCap);
                    enterpriseValueDisplay.textContent = formatLargeNumber(enterpriseValue);
                    currentPriceDisplay.textContent = `$${currentPrice.toFixed(2)}`;
                    epsDisplay.textContent = `$${eps.toFixed(2)}`;
                    peRatioDisplay.textContent = isNaN(peRatio) || peRatio === 0 ? 'N/A' : peRatio.toFixed(2);
                    forwardPeDisplay.textContent = isNaN(forwardPe) || forwardPe === 0 ? 'N/A' : forwardPe.toFixed(2);
                    dividendYieldDisplay.textContent = isNaN(dividendYield) ? 'N/A' : `${dividendYield.toFixed(2)}%`;
                    bookValuePerShareDisplay.textContent = isNaN(bookValuePerShare) || bookValuePerShare === 0 ? 'N/A' : `$${bookValuePerShare.toFixed(2)}`;
                    weekHighDisplay.textContent = `$${fiftyTwoWeekHigh.toFixed(2)}`;
                    weekLowDisplay.textContent = `$${fiftyTwoWeekLow.toFixed(2)}`;
                    growthDisplay.textContent = `${(growthRateDecimal * 100).toFixed(1)}%`;
                    intrinsicValueDisplay.textContent = `$${grahamIntrinsicValue.toFixed(2)}`;
                    dcfValueDisplay.textContent = `$${dcfValue.toFixed(2)}`;
                    pbValueDisplay.textContent = `$${pbValue.toFixed(2)}`;
                    averageFairValueDisplay.textContent = `$${averageFairValue.toFixed(2)}`;
                    mosFairValueDisplay.textContent = `$${mosFairValue.toFixed(2)}`;

                    upsideDisplay.textContent = `${upsidePercentage.toFixed(2)}%`;
                    upsideDisplay.classList.toggle('upside-positive', upsidePercentage >= 0);
                    upsideDisplay.classList.toggle('upside-negative', upsidePercentage < 0);

                    upsideMosDisplay.textContent = `${upsideMosPercentage.toFixed(2)}%`;
                    upsideMosDisplay.classList.toggle('upside-positive', upsideMosPercentage >= 0);
                    upsideMosDisplay.classList.toggle('upside-negative', upsideMosPercentage < 0);

                    resultsDiv.classList.remove('hidden');
                    console.log("Results section made visible.");

                    // --- Render Charts ---
                    if (historicalPrices.length > 0) {
                        renderHistoricalPriceChart(historicalDates, historicalPrices);
                        console.log("Historical price chart rendered.");
                    } else {
                        console.warn("Not enough historical data to render chart.");
                        historicalPriceNoData.classList.remove('hidden');
                    }
                    renderValuationComparisonChart(currentPrice, grahamIntrinsicValue, dcfValue, pbValue, averageFairValue, mosFairValue);
                    console.log("Valuation comparison chart rendered.");

                } catch (error) {
                    console.error('Calculation and display error:', error);
                    displayError(`Error during calculation or display: ${error.message}. Please check the console for more details.`);
                } finally {
                    // Re-enable buttons and hide loading indicator
                    loadingIndicator.classList.add('hidden'); // Hide general loader
                    calculateBtn.disabled = false;
                    calculateBtn.innerHTML = 'Calculate Fair Value'; // Reset button text
                    resetBtn.disabled = false;
                    console.log("Calculation process finished. Buttons re-enabled.");
                }
            });
        });
    </script>
</body>
</html>
